---
- name: testing windows
  hosts: 10.10.5.187
  tasks:
#     - name: downlod windows exporter
 #      win_command: replicadb --source-connect jdbc:sqlite:/c:\sqlite\Record.db --source-table EXTENSIONSCAN --sink-connect jdbc:mysql://10.10.5.62:3306/testdb?allowLoadLocalInfile=true --sink-user root --sink-table EXTENSIONSCAN_TMP --sink-password 6kt9tz8GlKKX --mode complete
 #      args:
  #       chdir: C:\ReplicaDB\bin\
   - name: Check that the service variable values are sane
     assert:
       that:
         - windows_exporter_state == 'started' and windows_exporter_start_mode != 'disabled'
     fail_msg: "You cannot manage the service with the windows_exporter_state and windows_exporter_start_mode settings"

   - name: Check current windows_exporter version.
     win_command: "{{ windows_exporter_bin_path }} --version"
     failed_when: false
     changed_when: false
     register: windows_exporter_version_check

   - name: Check if windows_exporter is already installed
     win_stat: 
       path: "{{ windows_exporter_bin_path }}"
     register: windows_exporter_installed_check

   - name: Download windows_exporter
     win_get_url:
      url: "{{ windows_exporter_download_url }}"
      dest: '%temp%\windows_exporter_install.msi'
     when: >
        windows_exporter_version_check.stderr is not defined
        or windows_exporter_version not in windows_exporter_version_check.stderr
        or not windows_exporter_installed_check.stat.exists
     register: windows_exporter_download_check

   - name: install Windows exporter
     win_package:
      path: '{{ ansible_env.TEMP }}\windows_exporter_install.msi'
      state: present
      arguments: "{{ windows_exporter_options }}"
    when: >
      windows_exporter_version_check.stderr is not defined
      or windows_exporter_version not in windows_exporter_version_check.stderr
      or not windows_exporter_installed_check.stat.exists
    register: windows_exporter_install_check
    notify: restart windows_exporter

   - name: windows_exporter service settings
     ansible.windows.win_service:
       name: windows_exporter
       start_mode: "{{ windows_exporter_start_mode }}"
       state: "{{ windows_exporter_state }}"

   - name: Verify windows_exporter is responding to requests.
      win_uri:
        url: http://localhost:9182/
        return_content: true
        register: metrics_output
        failed_when: "'Metrics' not in metrics_output.content"
      when:
       - windows_exporter_start_mode != 'disabled'
       - windows_exporter_start_mode != 'manual'
       - windows_exporter_state == 'started' or windows_exporter_state == 'restarted'
